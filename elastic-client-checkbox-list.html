<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="./elasticjs.html">
<link rel="import" href="./lodash.html">

<!--
Doc

Example:

        <elastic-client-checkbox-list></elastic-client-checkbox-list>

@demo demo/index.html
-->

<dom-module id="elastic-client-checkbox-list">
    <template>
        <template is="dom-repeat" items="{{facets}}" as="facet">
            <paper-checkbox
                name="[[facet.key]]",
                checked="{{facet.enabled}}"
            >{{facet.key}} ({{facet.count}})</paper-checkbox>
        </template>

    </template>

    <script>
        (function() {
            Polymer({
                is: 'elastic-client-checkbox-list',

                properties: {
                    buckets: {
                        type: Array
                    },

                    facets: {
                        type: Array,
                        computed: 'extractFacets(buckets)',
                        notify: true
                    },

                    facetSelection: {
                        type: Object,
                        readOnly: true,
                        value: {}
                    },

                    field: {
                        type: String
                    },

                    //'and' or 'or'
                    combinationType: {
                        type: String
                    },

                    ejsFilter: {
                        type: Object,
                        notify: true,
                        readOnly: true
                    }
                },

                observers: [
                    'buildFilter(facets.*, combinationType, field)'
                ],

                buildFilter: function() {
                    var me = this;
                    var filters = [];
                    var change;

                    _.each(this.facets, function(facet) {
                        if(me.facetSelection[facet.key] !== facet.enabled) {
                            change = true;
                            me.facetSelection[facet.key] = facet.enabled;
                        }

                        if(facet.enabled) {
                            filters.push(ejs.TermFilter(me.field, facet.key));
                        }
                    })

                    if(!change) {
                        console.log("No Change");
                        return
                    }

                    if(filters.length > 0) {
                        if(this.combinationType === 'and') {
                            this._setEjsFilter(ejs.AndFilter(filters));
                        } else {
                            this._setEjsFilter(ejs.OrFilter(filters));
                        }
                    } else {
                        this._setEjsFilter(undefined);
                    }
                },

                extractFacets: function(buckets) {
                    var me = this;
                    var facets = [];
                    _.each(buckets, function(bucket) {
                        facets.push({
                            key: bucket.key,
                            count: bucket.doc_count,
                            enabled: me.facetSelection[bucket.key]
                        });
                    });
                    return facets;
                }
            });
        })();
    </script>
</dom-module>
